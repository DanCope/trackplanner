# TrackPlanner v1.0 Planning

## Overview

With the MVP complete (7 features, drag-snap-place workflow proven), v1.0 focuses on making the tool genuinely useful for real layout planning sessions. The core themes are:

1. **More pieces** — Bridge piece to model the physical set accurately
2. **Better interaction** — Move placed pieces, zoom, pan
3. **Persistence** — Save and load layouts across sessions
4. **Undo safety net** — Experiment freely with undo/redo
5. **Quality of life** — Clear all, keyboard help, open port counter

## Feature Overview

| #   | Feature                    | Complexity | Value  | Est. Tasks |
| --- | -------------------------- | ---------- | ------ | ---------- |
| F8  | Bridge Piece               | Low        | High   | 5          |
| F9  | Canvas Viewport (Zoom/Pan) | Moderate   | High   | 8          |
| F10 | Drag Placed Pieces         | Moderate   | High   | 7          |
| F11 | Save/Load Layouts          | Low        | High   | 6          |
| F12 | Undo/Redo                  | Moderate   | Medium | 7          |
| F13 | UI Polish & Quick Wins     | Low        | Medium | 5          |

**Total estimated tasks:** 38

## Evaluated & Deferred: Canvas Rotation

Canvas rotation was considered but **deferred** for v1.0. Rationale:

- **High interaction complexity** — Every coordinate transform (drag, snap, pan, zoom) must account for canvas rotation. The `getWorldPositionFromEvent` function, snap calculations, and drag preview positioning all need inverse-rotation math.
- **Confusing UX** — Port direction indicators (N/S/E/W) become misleading when the canvas is rotated. Users would need to mentally un-rotate to understand connection directions.
- **Low unique value** — Pieces already auto-rotate during snapping — the most common reason to want rotation. Zoom + pan covers the "see a different area" use case.
- **Conflicts with pan** — Both pan and rotate want "drag on empty canvas" as their gesture. Would need a modifier key (e.g., Alt+drag to rotate), which is less discoverable.

**Recommendation:** Revisit in v2.0 if users request it after trying zoom+pan.

## Dependency Graph

```
F8  (Bridge Piece)     ── independent
F9  (Viewport)         ── independent (foundational)
F10 (Drag Placed)      ── after F9 (coord transforms must handle viewport)
F11 (Save/Load)        ── independent
F12 (Undo/Redo)        ── after F10 (should cover move actions)
F13 (UI Polish)        ── independent

Parallelizable groups:
  Group A: F8 + F9 + F11 (all independent)
  Group B: F10 (after F9)
  Group C: F12 (after F10)
  F13 can slot in anywhere
```

**Recommended order:** F8 → F9 → F11 → F10 → F13 → F12

This prioritises quick wins first (F8 is trivial, F9 is high-impact, F11 is high-value low-effort), then tackles the interaction complexity (F10, F12), with polish sprinkled in.

## Suggested Easy Wins (included in F13)

These were identified as high-value, low-effort additions:

1. **Clear All button** — Single button to wipe the layout. ~10 lines of code.
2. **Open port counter** — Display count of unconnected ports in the toolbar. Helps users see if their layout can close.
3. **Keyboard shortcuts help panel** — Toggleable overlay showing all shortcuts (R, F, Delete, etc.). Users currently have to discover these.
4. **Piece usage summary** — Show count of each piece type in use (e.g., "4× Straight, 8× Curve"). Useful for checking against physical inventory.
5. **Center on layout** — Button to auto-fit the viewport to show all placed pieces. Pairs with zoom/pan from F9.

## Architecture Notes

### Viewport Store (F9)

The current canvas uses a fixed `viewBox="0 0 1200 800"`. For zoom/pan, introduce a `ViewportStore` that tracks:

- `offsetX`, `offsetY` — pan offset in world coordinates
- `zoom` — zoom level (1.0 = default, >1 = zoomed in, <1 = zoomed out)

The SVG `viewBox` becomes: `{offsetX} {offsetY} {width/zoom} {height/zoom}`

All `getWorldPositionFromEvent` functions already use `svg.getScreenCTM()` which automatically accounts for viewBox changes — minimal plumbing needed.

### Drag Rework (F10)

The existing `DragStore` handles new-piece drags. For moving placed pieces:

- Add `sourcePieceId: string | null` to `DragStore` — non-null means "moving existing piece"
- `startMoveDrag(piece)` method: disconnects piece from neighbors, removes from layout, starts drag with piece's definition and current rotation
- Drop logic: same snap flow, but updates/re-adds the piece instead of always creating new
- `disconnectPiece()` already exists in `connections.ts`

### Serialization (F11)

`PlacedPiece.connections` is a `Map<string, string>` — not JSON-serializable. The save format needs to convert Maps to plain objects. Load needs to reconstruct Maps and resolve `PieceDefinition` references from type strings.

### Undo/Redo (F12)

Command pattern with an action stack:

- `AddPieceAction`, `RemovePieceAction`, `MovePieceAction`
- Each action has `execute()` and `undo()` methods
- Store keeps `undoStack` and `redoStack`
- New actions clear the redo stack

## Static Compatibility

✅ All features are fully client-side. No server code needed. No impact on static deployment.

## Testing Strategy

| Feature | Unit Tests                                 | E2E Tests                            |
| ------- | ------------------------------------------ | ------------------------------------ |
| F8      | Bridge definition geometry, port positions | Place bridge, snap to other pieces   |
| F9      | ViewportStore state transitions            | Scroll to zoom, drag to pan, buttons |
| F10     | DragStore move mode, disconnect/reconnect  | Select piece → drag → resnap         |
| F11     | Serialize/deserialize round-trip           | Save → reload page → load            |
| F12     | Action stack push/pop, undo/redo state     | Place → undo → redo                  |
| F13     | Port counter derivation                    | Clear all, keyboard help toggle      |

## References

- [MVP Planning](./README.md) — Original MVP feature breakdown
- [MVP Checklist](./CHECKLIST.md) — Completed MVP tasks
- [Product Brief](../docs/product-brief.md) — Vision and requirements
